# Web-сервисы

Веб-сервис (служба) – программа, которая организовывает взаимодействие между сайтами и клиентами. Apache и Nginx – самые распространенные представители.

---

## Apache

Apache – это свободное программное обеспечение для размещения веб-сервера. Он хорошо показывает себя в работе с масштабными проектами, поэтому заслуженно считается одним из самых популярных веб-серверов. Кроме того, **Apache** очень гибок в плане настройки, что даёт возможность реализовать все особенности размещаемого веб-ресурса.

**Apache** состоит из ядра и динамической модульной системы. Параметры системы изменяются с помощью конфигурационных файлов.
### Ядро

Ядро **Apache** разработано **Apache Software Foundation** на языке **C**. Основные функции — обработка конфигурационных файлов, протокол **HTTP/HTTPS** и загрузка модулей. Ядро может работать без модулей, но будет иметь ограниченный функционал.

### Модульная система

Модуль – отдельный файл, подключение которого расширяет изначальный функционал ядра. Они могут включаться в состав ПО при первоначальной установке или подгружаться позже через изменение конфигурационного файла.

Большинство из них отвечает за определенный аспект обработки клиентского запроса – поддержку различных языков программирования, безопасность, кэширование, аутентификацию и т.д. Таким образом, большая задача разбивается на несколько фаз, каждую из которых решает отдельный, узкоспециализированный модуль.

Для **Apache** существует больше 500 модулей. Многие популярные веб-приложения сразу выпускаются в виде модуля к **Apache**. Например, **ISPmanager** и **VDSmanager**.

### Виртуальные хосты

Веб-хост – это компонент сервера, отвечающий за обслуживание одного размещенного на нем объекта (сайта, виртуального сервера). Система виртуальных хостов **Apache** позволяет одновременно запускать несколько проектов с одного **IP**-адреса.

В Apache можно установить настройки модуля и ядра, а также вводить лимиты на потребление серверных ресурсов (трафик, **RAM**, **CPU**) для каждого виртуального хоста в отдельности. Это технологическая основа всего механизма веб-хостинга.

### Установка

```html
$ sudo apt install apache2
```

Зайдем на [localhost](http://localhost) чтобы убедиться что все работает:![[Pasted image 20240716083408.png]]
Добавим сервис в автозагрузку:

```html
$ systemctl enable apache2
```

### Конфигурация

Все настройки содержатся в папке `/etc/apache2/`:![[Pasted image 20240716083428.png]]
Внести изменения можно как через редактирование самого файла, так и через командную строку.

Веб-сервер **Apache** может запускать несколько веб-сайтов на одном компьютере. Каждый запущенный сайт («виртуальный хост») должен иметь свою собственную конфигурацию. Дефолный виртуальный хост описывается в файле `/etc/apache2/sites-available/000-default.conf`. Давайте посмотрим на него:![[Pasted image 20240716083521.png]]
Чтобы сделать свой хост, нужно создать корневую директорию, а также создать базовую страницу, которая будет отображаться при открытии сайта:
```html
$ mkdir /var/www/example1
$ echo “Hello” > /var/www/example1/index.html
```

Затем создаем конфигурационный файл:

```html
$ nano /etc/apache2/sites-available/example1.conf
```

И вставляем туда базовые настройки:![[Pasted image 20240716083608.png]]
Чтобы активировать ваш виртуальный хост, используйте команду `a2ensite`. Эта команда создаёт символическую ссылку файла в каталоге `/etc/apache2/sites-enabled`. Затем перезапустите веб-сервер:

```html
$ sudo a2ensite example1.conf
$ systemctl reload apache2
```

Осталось прописать доменное имя в файле `/etc/hosts`:![[Pasted image 20240716083640.png]]
И перейти по нему в браузере для проверки:![[Pasted image 20240716083652.png]]

---

## Nginx

**Nginx** — это веб-сервер с открытым исходным кодом, созданный работать под высокой нагрузкой, чаще всего используемый для отдачи статического контента, например, html страниц, медиафайлов, документов, архивов, картинок и т.д.

В отличие от других продуктов данного сегмента, **Nginx** использует иной принцип обработки входящих данных. ПО разбивает каждый запрос пользователя на несколько мелких, упрощая таким образом обработку каждого. В терминологии **Nginx** они получили название "рабочее соединение".

После обработки каждое соединение собирается в одном виртуальном контейнере, чтобы трансформироваться в единый первоначальный запрос, а после отправляется пользователю. Одно соединение может одновременно обрабатывать до 1024 запросов конечного пользователя.

Для уменьшения нагрузки на оперативную память веб-сервер использует выделенный сегмент памяти, который называется «пул» (pool). Он динамический и расширяется при увеличении длины запроса.

#### Установка
```html
$ sudo apt install nginx
```
Дальше **ВОЗМОЖНО** нужно импортировать официальный ключ, используемый **apt** для проверки подлинности пакетов. Инструкция. Скачайте ключ:
```
curl <https://nginx.org/keys/nginx_signing.key> | gpg --dearmor
    | sudo tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null
```
Проверьте, верный ли ключ был загружен:
```
gpg --dry-run --quiet --import --import-options import-show /usr/share/keyrings/nginx-archive-keyring.gpg
```
Вывод команды должен содержать полный отпечаток ключа
**573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62**
```
pub   rsa2048 2011-08-19 [SC] [expires: 2024-06-14]
      573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62
uid                      nginx signing key <signing-key@nginx.com>
```
_**Если отпечаток отличается от вышеуказанного, удалите файл ключа.**_

**Для подключения apt-репозитория для стабильной версии nginx, выполните следующую команду:**
```
echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \\
<http://nginx.org/packages/debian> `lsb_release -cs` nginx" \\
    | sudo tee /etc/apt/sources.list.d/nginx.list
```
Если предпочтительно использовать пакеты для основной версии **nginx**, выполните следующую команду вместо предыдущей:
```
echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \\
<http://nginx.org/packages/mainline/debian> `lsb_release -cs` nginx" \\
    | sudo tee /etc/apt/sources.list.d/nginx.list
```
Для использования пакетов из нашего репозитория вместо распространяемых в дистрибутиве, настройте закрепление:
```
echo -e "Package: *\\nPin: origin nginx.org\\nPin: release o=nginx\\nPin-Priority: 900\\n" \\
    | sudo tee /etc/apt/preferences.d/99nginx
```


#### Конфигурация

Файлы конфигурации nginx находятся в папке `/etc/nginx`. Рассмотрим их:

- **`/etc/nginx/nginx.conf`** – главный файл конфигурации nginx.
- **`/etc/nginx/sites-available`** – каталог с конфигурациями виртуальных хостов, т.е. каждый файл, находящийся в этом каталоге, содержит информацию о конкретном сайте – его имени, IP адресе, рабочей директории и т.д.
- **`/etc/nginx/sites-enabled`** – в этом каталоге содержаться конфигурации сайтов, обслуживаемых **nginx**, т.е. активных, как правило, это символические ссылки **sites-available** конфигураций, что очень удобно для оперативного включения и отключения сайтов

Теперь мы создадим виртуальный хост для **Nginx**, используя ту же процедуру, что использовалась для **Apache**. Вначале необходимо создать корневой каталог. По умолчанию **Nginx** требует хранить сайты в каталоге `/usr/share/nginx`. Назовем веб-проект `example1` и положим туда **html** файл, содержащий в себе заголовок `example.com`:
```
$ sudo mkdir -v /usr/share/nginx/example1.com
$ echo "<h1>Hello</h1>" | sudo tee /usr/share/nginx/example1.com/index.html
```
Удалим виртуальный хост по умолчанию, так как далее заменим его своим:
```html
$ sudo rm /etc/nginx/sites-enabled/default
```
Теперь создаем файл виртуального хоста для домена `example1.com` и внесем туда настройки:
```
$ sudo nano /etc/nginx/sites-available/example1.com
```
![[Pasted image 20240716083930.png]]
Убедимся в отсутствии ошибок в конфигурации:
```html
$ sudo nginx -t
```
Активируем сайт, создав символическую ссылку на каталог `sites-enabled`:
```html
$sudo ln -s /etc/nginx/sites-available/example1.com /etc/nginx/sites-enabled/example1.com
```

Посмотрим на результат нашей работы, перейдя по адресу нашего хоста в браузере:![[Pasted image 20240716083952.png]]

---

#### настройка nginx от DDoS

переходим в `/etc/nginx/sites-enable/default` - тут находится стартовая страничка **nginx**. Выставляем следующие параметры:

`limit_req zone=ltwo burst=5 nodelay;`
![[Pasted image 20240717192948.png]]

**далее переходим в конфигурационный файл `nginx.conf`, в нём надо внести следующие изменения:**
``` 
limit_req_zone $binary_remote_addr zone=ltwo:10m rate=3r/s;
```
![[Pasted image 20240717193054.png]]
В `/var/log/nginx/error.log` будут отображаться ошибки превышения количества запросов пользователями.
![[Pasted image 20240717193235.png]]

log файл даст нам нужную информация для настройки фильтрации **fail2ban**.

В `jail.local` внесём следующие параметры:
```
[nginx-limit-req]
port = http, https
enabled = true
filter = nginx-limit-req
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /var/log/nginx/*error.log
findtime = 600
bantime = 3600
maxretry = 4
```
![[Pasted image 20240717193400.png]]

после чего нам необходимо изменить настройку, что **iptables** не отсылал **reject** а отсылал **drop**, так как для борьбы с ботами - это более эффективно.

создадим (или допишем) файл `/etc/fail2ban/action.d/iptables-blocktype.local`:
```
[Init]
blocktype = DROP
```
Перезапускаем службу:
```
service fail2ban restart
```
Теперь нам нужно посмотреть, что **iptables** отрабатывает и наберём:
``` 
iptables -L -v
```
![[Pasted image 20240717193654.png]]
Убедимся. что настройки в **fail2ban** применились и введём: `fail2ban-client status`![[Pasted image 20240717193725.png]] _видим, что фильтры работают по nginx-limit-req, sshd_
```
fail2ban-client status nginx-limit-req
```
![[Pasted image 20240717193806.png]]