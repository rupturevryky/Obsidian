## Web-сервисы

Веб-сервис (служба) – программа, которая организовывает взаимодействие между сайтами и клиентами. Apache и Nginx – самые распространенные представители.

### Apache

Apache – это свободное программное обеспечение для размещения веб-сервера. Он хорошо показывает себя в работе с масштабными проектами, поэтому заслуженно считается одним из самых популярных веб-серверов. Кроме того, Apache очень гибок в плане настройки, что даёт возможность реализовать все особенности размещаемого веб-ресурса.

Apache состоит из ядра и динамической модульной системы. Параметры системы изменяются с помощью конфигурационных файлов.

#### Ядро

Ядро Apache разработано Apache Software Foundation на языке C. Основные функции — обработка конфигурационных файлов, протокол HTTP/HTTPS и загрузка модулей. Ядро может работать без модулей, но будет иметь ограниченный функционал.

#### Модульная система

Модуль – отдельный файл, подключение которого расширяет изначальный функционал ядра. Они могут включаться в состав ПО при первоначальной установке или подгружаться позже через изменение конфигурационного файла.

Большинство из них отвечает за определенный аспект обработки клиентского запроса – поддержку различных языков программирования, безопасность, кэширование, аутентификацию и т.д. Таким образом, большая задача разбивается на несколько фаз, каждую из которых решает отдельный, узкоспециализированный модуль.

Для Apache существует больше 500 модулей. Многие популярные веб-приложения сразу выпускаются в виде модуля к Apache. Например, ISPmanager и VDSmanager.

#### Виртуальные хосты

Веб-хост – это компонент сервера, отвечающий за обслуживание одного размещенного на нем объекта (сайта, виртуального сервера). Система виртуальных хостов Apache позволяет одновременно запускать несколько проектов с одного IP-адреса.

В Apache можно установить настройки модуля и ядра, а также вводить лимиты на потребление серверных ресурсов (трафик, RAM, CPU) для каждого виртуального хоста в отдельности. Это технологическая основа всего механизма веб-хостинга.

#### Установка

```html
$ sudo apt install apache2
```

Зайдем на [localhost](http://localhost) чтобы убедиться что все работает:![[Pasted image 20240716083408.png]]
Добавим сервис в автозагрузку:

```html
$ systemctl enable apache2
```

#### Конфигурация

Все настройки содержатся в папке `/etc/apache2/`:![[Pasted image 20240716083428.png]]
Внести изменения можно как через редактирование самого файла, так и через командную строку.

Веб-сервер **Apache** может запускать несколько веб-сайтов на одном компьютере. Каждый запущенный сайт («виртуальный хост») должен иметь свою собственную конфигурацию. Дефолный виртуальный хост описывается в файле `/etc/apache2/sites-available/000-default.conf`. Давайте посмотрим на него:![[Pasted image 20240716083521.png]]
Чтобы сделать свой хост, нужно создать корневую директорию, а также создать базовую страницу, которая будет отображаться при открытии сайта:
```html
$ mkdir /var/www/example1
$ echo “Hello” > /var/www/example1/index.html
```

Затем создаем конфигурационный файл:

```html
$ nano /etc/apache2/sites-available/example1.conf
```

И вставляем туда базовые настройки:![[Pasted image 20240716083608.png]]
Чтобы активировать ваш виртуальный хост, используйте команду `a2ensite`. Эта команда создаёт символическую ссылку файла в каталоге `/etc/apache2/sites-enabled`. Затем перезапустите веб-сервер:

```html
$ sudo a2ensite example1.conf
$ systemctl reload apache2
```

Осталось прописать доменное имя в файле `/etc/hosts`:![[Pasted image 20240716083640.png]]
И перейти по нему в браузере для проверки:![[Pasted image 20240716083652.png]]

---

### Nginx

Nginx — это веб-сервер с открытым исходным кодом, созданный работать под высокой нагрузкой, чаще всего используемый для отдачи статического контента, например, html страниц, медиафайлов, документов, архивов, картинок и т.д.

В отличие от других продуктов данного сегмента, Nginx использует иной принцип обработки входящих данных. ПО разбивает каждый запрос пользователя на несколько мелких, упрощая таким образом обработку каждого. В терминологии Nginx они получили название рабочее соединение.

После обработки каждое соединение собирается в одном виртуальном контейнере, чтобы трансформироваться в единый первоначальный запрос, а после отправляется пользователю. Одно соединение может одновременно обрабатывать до 1024 запросов конечного пользователя.

Для уменьшения нагрузки на оперативную память веб-сервер использует выделенный сегмент памяти, который называется «пул» (pool). Он динамический и расширяется при увеличении длины запроса.

#### Установка
```html
$ sudo apt install nginx
```

#### Конфигурация

Файлы конфигурации nginx находятся в папке /etc/nginx. Рассмотрим их:

- **/etc/nginx/nginx.conf** – главный файл конфигурации nginx.
- **/etc/nginx/sites-available** – каталог с конфигурациями виртуальных хостов, т.е. каждый файл, находящийся в этом каталоге, содержит информацию о конкретном сайте – его имени, IP адресе, рабочей директории и т.д.
- **/etc/nginx/sites-enabled** – в этом каталоге содержаться конфигурации сайтов, обслуживаемых nginx, т.е. активных, как правило, это символические ссылки sites-available конфигураций, что очень удобно для оперативного включения и отключения сайтов

Теперь мы создадим виртуальный хост для Nginx, используя ту же процедуру, что использовалась для Apache. Вначале необходимо создать корневой каталог. По умолчанию Nginx требует хранить сайты в каталоге /usr/share/nginx. Назовем веб-проект example1 и положим туда html файл, содержащий в себе заголовок [example.com](http://example.com):
```
$ sudo mkdir -v /usr/share/nginx/example1.com
$ echo "<h1>Hello</h1>" | sudo tee /usr/share/nginx/example1.com/index.html
```
Удалим виртуальный хост по умолчанию, так как далее заменим его своим:
```html
$ sudo rm /etc/nginx/sites-enabled/default
```
Теперь создаем файл виртуального хоста для домена [example1.com](http://example1.com) и внесем туда настройки:
```
$ sudo nano /etc/nginx/sites-available/example1.com
```
![[Pasted image 20240716083930.png]]
Убедимся в отсутствии ошибок в конфигурации:
```html
$ sudo nginx -t
```
Активируем сайт, создав символическую ссылку на каталог sites-enabled:
```html
$sudo ln -s /etc/nginx/sites-available/example1.com /etc/nginx/sites-enabled/example1.com
```

Посмотрим на результат нашей работы, перейдя по адресу нашего хоста в браузере:![[Pasted image 20240716083952.png]]

---

## Cron

Системным администраторам, да и обычным пользователям часто приходится автоматизировать различные задачи по обслуживанию и работе с **Linux** с помощью скриптов. Это очень удобно, вы просто запускаете скрипт, и он делает все что необходимо без вашего вмешательства. Следующий шаг в этом пути - настроить автоматически запуск нужного скрипта в нужное время. Именно для этих задач в **Linux** используется системный сервис **cron**. Это планировщик, который позволяет выполнять нужные вам скрипты раз в час, раз в день, неделю или месяц, а также в любое заданное вами время или через любой интервал. Программа часто используется даже другими службами операционной системы.

Фактически, **Cron** - это сервис, как и большинство других сервисов **Linux**, он запускается при старте системы и работает в фоновом режиме. Его основная задача выполнять нужные процессы в нужное время. Существует несколько конфигурационных файлов, из которых он берет информацию о том что и когда нужно выполнять. Сервис открывает файл /etc/crontab, в котором указаны все нужные данные. Часто, в современных дистрибутивах там прописан запуск утилиты `run-parts`, которая запускает нужные скрипты из следующих папок:
- **`/etc/cron.minutely`** - каждую минуту;
- **`/etc/cron.hourly`** - каждый час;
- **`/etc/cron.daily`** - каждый день;
- **`/etc/cron.weekly`** - каждую неделю;
- **`/etc/cron.monthly`** - каждый месяц.

В этих папках должны находиться скрипты, которые нужно выполнять с указанным интервалом. Скрипты должны иметь права на выполнение и их имя не должно содержать точки. Это очень сильно облегчает работу с планировщиком для новых пользователей. Также в файле `crontab` прописан запуск команды **anacron**, которая работает так же как и **cron**, только предназначена для задач, которые нужно выполнять раз в длительный период, например, раз в день, неделю, месяц, год.

Она позволяет выполнять их даже если компьютер работает не всегда и время от времени выключается. Дата выполнения задания последний раз записывается в файл `/var/spool/anacron`, а затем, при следующем запуске **anacron** проверяет был ли запущен нужный процесс в нужное время, и если нет, то запускает его. Сам же сервис **cron** больше рассчитан на выполнение задач в течение дня или с точно расписанным временем и датой.

Для настройки времени, даты и интервала когда нужно выполнять задание используется специальный синтаксис файла cron и специальная команда. Конечно, вы всегда можете отредактировать файл `/etc/crontab`, но этого делать не рекомендуется. Вместо этого, есть команда crontab:

`$ crontab -e`

Ее всегда желательно выполнять с опцией -e, тогда для редактирования правил будет использован ваш текстовый редактор по умолчанию. Команда открывает вам временный файл, в котором уже представлены все текущие правила **cron** и вы можете добавить новые. При первом запуске вам будет предложено выбрать желаемый текстовый редактор (**nano**, **vim**).
![[Pasted image 20240716084039.png]]
Где
![[Pasted image 20240716084048.png]]
Чтобы стало понятнее, давайте разберем на примере. Создадим инструкцию на выполнение скрипта `/usr/local/bin/script.sh` (cкрипт выводит в терминал сообщение) `каждую среду в 15 часов 30 минут`:

```html
30 15 * * 3 /usr/local/bin/script.sh
```

Символ `*` означает что инстуркция выполняется во все возможные значения аргумента. В нашем случае `каждую тридцатую минуту пятнадцатого часа во все дни и все месяцы, которые являются третьим днем недели (то есть средой)`. Можно писать сокращенное название дня недели вместо его порядкового номера, например `sun` - воскресенье.

Для того чтобы указать определенный интервал нужно использовать символ "`-`", например, каждый час, с семи утра до семи вечера:
```html
0 7-19  * * * /usr/local/bin/script.sh
```

Если нужно запустить команду несколько раз, можно использовать разделитель "`,`". Например, запустим скрипт в 5 и 35 минут пятого (16:05 и 16:35), каждый день:

```html
5,35 16  * * * /usr/local/bin/script.sh
```

Вы можете захотеть не указывать отдельно время, а просто указать интервал, с которым нужно запускать скрипт, например, `раз в 10 минут`. Для этого используется разделитель косая черта - "`/`":
```html
/10 * * * * /usr/local/bin/script.sh
```

Кроме того, для некоторых часто используемых наборов были придуманы переменные, вот они:

**@reboot** - при загрузке, только один раз;
**@yearly, @annually** - раз год;
**@monthly** - раз в месяц;
**@weekly** - раз в неделю;
**@daily, @midnight** - каждый день;
**@hourly** - каждый час.

Например, вот так просто будет выглядеть команда запуска скрипта `раз в час`:
```html
@hourly /usr/local/bin/script.sh
```

После завершения работы команды **cron** файл будет обработан и все правила будут добавлены в `/var/spool/cron/crontabs/имя_пользователя` причем добавленные процессы будут запускаться именно от того пользователя, от которого вы их добавляли.

Поэтому тут нужно быть аккуратным, и если вам нужно выполнять скрипты от рута, то и **crontab** нужно выполнить от рута, а не от пользователя. Это часто становится причиной проблем.

Можно посмотреть задачи **cron** для суперпользователя, для этого можно воспользоваться опцией `-l`:
`$ crontab -l`

Вы можете удалить все существующие задачи командой `-r`:
`$ crontab -r`