# Введение 

**Iptables** является утилитой, выполняющей функции межсетевого экрана. Настройка **iptables** производится в командной строке, с помощью правил **iptables** можно разрешать или блокировать прохождение трафика. Когда происходит попытка установления соединения с текущей машиной, **iptables** просматривает список правил в списке, чтобы понять, как нужно поступить в этом случае. Если правила нет, то выполняется действие по умолчанию. Как правило, **itpables** предустанавливается на всех дистрибутивах **Linux**.

---
# Установка и использование

Подсистема **iptables** встроенa в ядро, но вот набор утилит для управления не всегда поставляется вместе с системой. Для установки утилиты наберите:
```shell
sudo apt install iptables
```
Когда установка **iptables** будет завершена, можно переходить к настройке, но давайте сначала рассмотрим синтаксис утилиты. Обычно команда имеет такой общий вид:
```shell
iptables -t # таблица действие цепочка дополнительные_параметры
```
Таблица указывает таблицу, с которой нужно работать, этот параметр можно упустить, действие - нужное действие, например, создать или удалить правило, а дополнительные параметры описывают действие и правило, которое нужно выполнить.

Осталось рассмотреть основные действия, которые позволяет выполнить **iptables**:
- **-F** - очистить все правила;
- **-A** - добавить правило в цепочку;
- **-С** - проверить все правила;
- **-D** - удалить правило;
- **-I** - вставить правило с нужным номером;
- **-L** - вывести все правила в текущей цепочке;  отображать номера правил;
  
  Проверить текущие правила:
  ```
  sudo iptables -L -v
	```
- **-S** - вывести все правила;
- **-N** - создать цепочку;
- **-X** - удалить цепочку;
- **-R** - заменить правило в цепочке;
- **-E** - переименовать цепочку;
- **-V** - отобразить версию;
- **-P** - установить действие по умолчанию.

Дополнительные опции для правил:
- **-p** - указать протокол, один из **tcp**, **udp**, **udplite**, **icmp**, **icmpv6**, **esp**, **ah**, **sctp**, **mh**;
- **-s** - указать **ip** адрес устройства-отправителя пакета;
- **-d** - указать **ip** адрес получателя;
- **-i** - входной сетевой интерфейс (обрабатывать только входящие на конкретный сетевой интерфейс пакеты);
- **-o** - исходящий сетевой интерфейс (обрабатывать только исходящие из конкретного сетевого интерфейса пакеты);
- **-j** - выбрать действие, если правило подошло (ACCEPT, DROP ets...);
- **-v** - вывести более подробную информацию;  отображать номера правил;
- **-n** - отображать параметры в числовом виде; отображать номера правил;
- **-x** - отобразить точные значения;
- **-g** - переход к другой цепочке правил.

`–src-range` – диапазон **IP** источников; в отличии от `--source` и `--destination` позволяет указать диапазон между двумя конкретными адресами, а не подсетью; допустимо инвертирование (`!`).

### Восклицательный знак ! инвертирует условие

**например:**
`iptables -A INPUT -s ! 192.168.0.50 -j DROP`
- запретит соединение всем хостам, кроме **192.168.0.50**.

---
## **Практика Iptables**

---
### Отклонить все исходящие сетевые подключения
1. Третья строка правил разрешает только текущие исходящие и установленные соединения.
2. Это очень полезно, когда вы вошли на сервер через **ssh** или **telnet**.
```shell
iptables -F OUTPUT
iptables -A OUTPUT -j REJECT
iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT
```
---
### Отклонение всех входящих сетевых подключений
```shell
iptables -F INPUT
iptables -A INPUT -j REJECT
iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
```

---

### Отклонение всех сетевых подключений
1. Это правило отключит и заблокирует все сетевые соединения, входящие или исходящие.
```shell
iptables -F
iptables -A INPUT -j REJECT
iptables -A OUTPUT -j REJECT
iptables -A FORWARD -j REJECT
```

---

### Отклонение входящих ping запросов 

**Это правило iptables сбрасывает все входящие запросы ping.**

1. Разница между **DROP** и **REJECT** заключается в том, что **DROP** автоматически отбрасывает входящий пакет, тогда как **REJECT** приведет к возврату ошибки **ICMP**.
```shell
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
```

---

### Разрыв telnet-соединений

1. Это правило iptables блокирует любой исходящий трафик на любой хост, порт назначения которого равен **23** (**telnet**)
```shell
iptables -A OUTPUT -p tcp --dport telnet -j REJECT
iptables -A INPUT -p tcp --dport telnet -j REJECT
```
2. Для организации сеанса Telnet-связи с другим компьютером используется следующая команда: 
```shell
telnet <ip address>
```

---

### Отклонение исходящих ssh-соединений

1. Это правило **iptables** будет отклонять все исходящие соединения, поступающие с локального порта **22** (**ssh**).
```shell
iptables -A OUTPUT -p tcp --dport ssh -j REJECT
```

---

### Отклонение входящих ssh-соединений

1. Сброс всех входящих подключений к локальному порту **22** (**ssh**).
```shell
iptables -A INPUT -p tcp --dport ssh -j REJECT
```

---

### Отклонение всего входящего трафика, кроме ssh и локальных подключений

1. Эти правила будут отклонять все входящие подключения к серверу, кроме подключений к порту 22 (SSH).
```shell
iptables -A INPUT -j REJECT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -p tcp --dport ssh -j ACCEPT
```

---

### Прием входящих ssh-соединений с определенного IP-адреса

1. Используя это правило **iptables**, мы заблокируем все входящие подключения к порту **22** (**ssh**), кроме хоста с **IP**-адресом **77.66.55.44**.
2. Это означает, что только хост с **IP 77.66.55.44** сможет использовать **ssh**.
```shell
iptables -A INPUT -p tcp --dport ssh -j REJECT
iptables -A INPUT -p tcp -s 77.66.55.44 --dport ssh -j ACCEPT
```

---

### Прием входящих ssh-соединений с определенного MAC-адреса

1. Используя это правило **iptables**, мы заблокируем все входящие подключения к порту **22** (**ssh**), кроме хоста с **MAC**-адресом **00:e0:4c:f1:41:6b**.
2. Другими словами, все **ssh**-соединения будут ограничены одним хостом с **MAC**-адресом **00:e0:4c:f1:41:6b**.
```shell
iptables -A INPUT -m mac --mac-source 00:e0:4c:f1:41:6b -p tcp --dport ssh -j ACCEPT
iptables -A INPUT -p tcp --dport ssh -j REJECT
```

---

### Отклонение входящих подключений направленные на TCP порт 3333 

1. Следующее правило **iptables** сбрасывает весь входящий трафик на **TCP**-порту **3333**
```shell
iptables -A INPUT -p tcp --dport 3333 -j REJECT
```

---

### Отклонять весь входящий трафик Telnet, кроме указанного IP-адреса

1. Следующее правило **iptables** отклоняет весь входящий трафик **Telnet**, кроме запроса на соединение с **IP**-адреса **222.111.111.222**.
```shell
iptables -A INPUT -t filter ! -s 222.111.111.222 -p tcp --dport 23 -j REJECT
```
- Восклицательный знак, разделенный пробелом со значением параметра, означает, что правило распространяется на все пакеты
- Напоминаю, все правила в **netfilter** распределены по таблицам. Чтобы работать с конкретной таблицей, необходимо использовать ключ` -t`.
- **filter**. Таблица по умолчанию. С ней работаем, если упускаем ключ `-t`. Встроены три цепочки — **INPUT** (входящие), **OUTPUT** (исходящие) и **FORWARD** (проходящие пакеты)

---

### Отклонять весь входящий трафик ssh, кроме указанного диапазона IP-адресов

1. Следующее правило **iptables** отклоняет весь входящий трафик **ssh**, кроме запроса на соединение из диапазона **IP**-адресов **10.1.1.90 – 10.1.1.1.100**.
2. Удаление “**!**” из приведенного ниже правила отклонить весь трафик **ssh**, исходящий из диапазона IP-адресов **10.1.1.90 – 10.1.1.100**.
```shell
iptables -A INPUT -t filter -m iprange ! --src-range 10.1.1.90-10.1.1.100 -p tcp --dport 22 -j REJECT
```

---

### Отклонять весь весь исходящий трафик на конкретный удаленный хост

1. Следующее правило **iptables** отклоняет весь исходящий трафик на удаленный хост с **IP**-адресом **222.111.111.222**.
```shell
iptables -A OUTPUT -d 222.111.111.222 -j REJECT
```

---

### Записать событие и сбросить

1. Чтобы записать в журнал движение пакетов перед сбросом, добавим правило:
```shell
iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j LOG --log-prefix "IP_SPOOF A: "
iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP
```
2. Проверим журнал (по умолчанию `/var/log/messages`):
```shell
tail -f /var/log/messages
grep -i --color 'IP SPOOF' /var/log/messages
```

---
# Теория 
---
## Основные понятия

![[Pasted image 20240717144947.png]]

---
## Виды пакетов (-A)

Все пакеты делятся на три типа: входящие, исходящие и проходящие. Входящие - это те, которые были отправлены на этот компьютер, исходящие - отправленные из этого компьютера в сеть. А проходящие - это пакеты, которые просто должны быть пересланы дальше, например, если ваш компьютер выступает в качестве маршрутизатора.

Соответственно в фильтре **iptables** все пакеты делятся на три аналогичные цепочки:

- **INPUT** - обрабатывает входящие пакеты и подключения. Например, если какой-либо внешний пользователь пытается подключиться к вашему компьютеру по ssh или любой веб-сайт отправит вам свой контент по запросу браузера. Все эти пакеты попадут в эту цепочку;
- **FORWARD** - эта цепочка применяется для проходящих соединений. Сюда попадают пакеты, которые отправлены на ваш компьютер, но не предназначены ему, они просто пересылаются по сети к своей цели. Как я уже говорил, такое наблюдается на маршрутизаторах или, например, если ваш компьютер раздает wifi;
- **OUTPUT** - эта цепочка используется для исходящих пакетов и соединений. Сюда попадают пакеты, которые были созданы при попытке выполнить `ping` или когда вы запускаете браузер и пытаетесь открыть любой сайт.

есть еще две дополнительные цепочки правил:

- **prerouting** - в эту цепочку пакет попадает перед обработкой **iptables**, система еще не знает куда он будет отправлен, в **input**, **output** или **forward**;
- **postrouting** - сюда попадают все проходящие пакеты, которые уже прошли цепочку **forward**.

Но если вы думаете что можно просто полностью закрыть цепочку **Input** для увеличения безопасности, то вы очень сильно ошибаетесь. При работе сети используются обе цепочки **input** и **output**. Например, вы пытаетесь выполнить `ping`, данные отправляются через **output**, но ответ приходит через **input**. То же самое происходит при просмотре сайтов и других действиях. А вот цепочка **forward** может вообще не использоваться если ваш компьютер не является маршрутизатором. Так что настройка **iptables** должна выполняться очень аккуратно.

---
### Таблицы ipatables (-t)

Над цепочками правил в **iptables** есть еще один уровень абстракции, и это таблицы. В системе есть несколько таблиц, и все они имеют стандартный набор цепочек **input**, **forward** и **output**. Таблицы предназначены для выполнения разных действий над пакетами, например для модификации или фильтрации. Сейчас это для вас не так важно и будет достаточно знать что фильтрация пакетов **iptables** осуществляется в таблице **filter**. Но мы рассмотрим их все:

- **raw** - предназначена для работы с сырыми пакетами, пока они еще не прошли обработку;
- **mangle** - предназначена для модификации пакетов;
- **nat** - обеспечивает работу **nat**, если вы хотите использовать компьютер в качестве маршрутизатора;
- **filter** - основная таблица для фильтрации пакетов, используется по умолчанию.
![[Pasted image 20240717150045.png]]

---
## Правила и действия (targets) (-j)

Перед тем как перейти к созданию списка правил **iptables** нужно рассмотреть как они работают и какие бывают. Для каждого типа пакетов можно установить набор правил, которые по очереди будут проверяться на соответствие с пакетом и если пакет соответствует, то применять к нему указанное в правиле действие. Правила образуют цепочку, поэтому **input**, **output** и **forward** называют цепочками, цепочками правил. Действий может быть несколько:

- **ACCEPT** - разрешить прохождение пакета дальше по цепочке правил;
- **DROP** - удалить пакет;
- **REJECT** - отклонить пакет, отправителю будет отправлено сообщение, что пакет был отклонен;
- **LOG** - сделать запись о пакете в лог файл;
- **QUEUE** - отправить пакет пользовательскому приложению.
- **RETURN** -  прекращает движение пакета по текущей цепочки правил и производит возврат в вызывающую цепочку, если такая цепочка была вложенной.

Правила могут проверять любые соответствия, например, по **ip**, по **порту** **получателя** или **отправителя**, **заголовкам пакета** и многому другому. Если пакет не подходит ни одному из правил, то к нему применяется действие по умолчанию, обычно **ACCEPT**.

---
## Состояния соединений (-m state --state)

Можно ограничивать подключения к службам на основе состояния их подключения.

- **NEW** - Пакет, запрашивающий новое соединение, например, HTTP-запрос.
- **ESTABLISHED** - пакет, являющийся частью уже существующего соединения.
- **RELATED** - пакет, запрашивающий новое соединение, но являющийся частью существующего соединения. Например, **FTP** использует **порт 21** для установления соединения, но данные передаются через другой порт (обычно **порт 20**).
- **INVALID** - пакет, который не является частью какого-либо соединения в таблице отслеживания соединений

---
# File2ban

**File2ban** - это один из способов **предотвратить взлом методом брутфорса**.

Написан на языке программирования **Python**, может работать на **POSIX**-системах имеющих встроенный менеджер пакетов и брандмауэр, например, **iptables** .**Fail2ban** отслеживает файлы журналов, такие как `/var/log/auth.log` для обнаружения подозрительной активности. Обычно **Fail2ban** используется для обновления правил с целью блокировки IP-адресов на определённое время, но можно настроить и другие действия — например, отправку письма по электронной почте.

Принцип работы **fail2ban** прост. Специальный сервис ищет в системных журналах (логах) записи о неудачных попытках аутентификации и при определенных условиях с помощью **iptables** блокирует **IP**-адреса, с которых ведется атака.

Основная идея **Fail2ban** - при превышении заданного числа неудачных вводов пароля подряд (по умолчанию - 6) бан **IP**, с которого были попытки подбора на заданное время (по умолчанию - 600 секунд).

---
### Установка

``` 
$ apt-get install fail2ban
```
`apt install ipset` - дополнение, чтобы **fail2ban** мог эффективнее блокировать большое количество запросов.

---
### Конфигурация

На данном этапе **Fail2ban** уже готов к работе, базовая защита **SSH** сервера от перебора паролей будет включена по умолчанию. Но лучше всё-же внести некоторые изменения следуя рекомендациям ниже.

У программы два основных файла конфигурации:

**`/etc/fail2ban/fail2ban.conf`** - отвечает за настройки запуска процесса **Fail2ban**

**`/etc/fail2ban/jail.conf`** - содержит настройки защиты конкретных сервисов

Файл `jail.conf` поделён на секции, так называемые «изоляторы» (jails), каждая секция отвечает за определённый сервис и тип атаки. Например секция `[ssh]` отвечает за защиту **SSH** от **brute–force** атак. Параметры из секции `[DEFAULT]` применяются ко всем секциям.

**Основные параметры файла `jail.conf`**

- **ignoreip** — **IP**–адреса, которые не должны быть заблокированы. Можно задать список **IP**-адресов разделённых пробелами, маску подсети, или имя **DNS**–сервера.
- **bantime** — время бана в секундах, по истечении которого IP–адрес удаляется из списка заблокированных.
- **maxretry** — количество подозрительных событий, после которых применяется правило. В контексте брутфорса — это число неудавшихся попыток логина, после которых происходит блокировка.
- **enabled** — значение указывает что данный **jail** активен, выключает действие изолятора.
- **port** — указывает на каком порту или портах запущен целевой сервис.
- **filter** — имя фильтра с регулярными выражениями, по которым идёт поиск «подозрительных совпадений» в журналах сервиса.
- **logpath** — путь к файлу журнала, который программа **Fail2ban** будет обрабатывать с помощью заданного ранее фильтра. Вся история удачных и неудачных входов в систему, в том числе и по **SSH**, по умолчанию записывается в **log**–файл.

#### Некоторые команды

Вывод работы программы:
```
fail2ban-client status [jail]
```
Разблокировать IP:
```
fail2ban-client unban [IP]
```

#### Пример настройки fail2ban

Прежде чем вносить изменения следуя рекомендациям, отметим, что не стоит редактировать основной файл настроек `jail.conf`, для этого предусмотрены файлы с расширением `*.local`, которые автоматически подключаются и имеют высший приоритет.
```shell
vi /etc/fail2ban/jail.local
```
```
[DEFAULT]
## Постоянный IP-адрес.
## Если не переопределить ignoreip здесь,
## то стоит закомментировать этот параметр в jail.conf.
ignoreip = 57.66.158.131

[ssh]
## если в течении 1 часа:
findtime    = 3600
## произведено 6 неудачных попыток логина:
maxretry    = 6
## то банить IP на 24 часа:
bantime     = 86400
```
Пример для `[sshd]`:
```
[sshd]
enable = true - указывает на то, что данные фильтр включен
port = ssh
filter = sshd
logpath = /var/log/auth.log - указываем где брать информацию
maxretry = 3
bantime = 3600
ignoreip = 127.0.0.1

```
Осталось перезапустить **Fail2ban**:
```shell
service fail2ban restart
```

## Практика Fail2ban

```shell
apt install fail2banapt install ipset
```
Давайте найдём параметр бан в `jail.conf` или во вновь созданном файле `jail.local` внесём следующие параметры:
```
[sshd]
enable = true #модуль shhd включен
port = ssh #ваш номер порта ssh
filter = sshd #применяемый фильтр
logpath = /var/log/auth.log #log-файл
maxretry = 3 #максимальное количество попыток входа
bantime = 3600 #после максимального количества попыток забанить на 3600 сек
ignoreip = 127.0.0.1 #
```
```
[nginx-limit-req]
port = http, https
enabled = true
filter = nginx-limit-req
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /var/log/nginx/*error.log
findtime = 600
bantime = 3600
maxretry = 4
```
Но как мы уже знаем, настройки конфигурационных файлов по умолчанию могут быть перезаписаны при обновлении, поэтому создаём новый файл:
`touch iptables-blocktype.local`

где нам нужно внести следующую настройку:
```
[Init]
blocktype = DROP
```
```
service fail2ban restart
```