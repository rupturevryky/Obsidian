### SFTP

**FTP (File Transfer Protocol)**, или протокол передачи файлов, был популярным методом незашифрованной передачи файлов между двумя удаленными системами.

**SFTP (Secure FTP)**, протокол передачи файлов по **SSH**, или безопасный протокол передачи файлов, — это отдельный протокол, поддерживающий **SSH**, который работает схожим образом, но использует защищенное подключение. Его преимуществом является возможность использования защищенного подключения для передачи файлов и просмотра файловой системы как на локальной, так и на удаленной системе.

Практически во всех случаях использование **SFTP** будет более предпочтительным по сравнению с **FTP** из-за имеющихся у первого функций безопасности и возможности использования подключения **SSH**. **FTP** — это небезопасный протокол, который следует использовать в ограниченных случаях или в сетях, которым вы доверяете.

По умолчанию **SFTP** использует протокол **SSH** для аутентификации и установки защищенного подключения. По этой причине протокол использует те же методы аутентификации, что и **SSH**.

Так как **SFTP** работает поверх **SSH**, первым делом необходимо установить **OpenSSH** со стороны сервера (хранилища):
```bash
$ sudo apt install openssh-server
```
Также необходимо установить **ssh** на стороне клиента (устройства, с которого планируется доступ к хранилищу):
```bash
$ sudo apt install ssh
```
Для безопасного использования **SFTP**, лучше всего создать группы и пользователей, которые будут использовать только эту службу:
```bash
$ sudo useradd -g sftpgroup sftpuser
$ sudo passwd sftpuser
```
Cоздадим каталоги и изменим их доступ:
```bash
$ sudo mkdir -p /data/sftpuser/upload 
$ chown -R root.sftpgroup /data/sftp 
$ chown -R sftpuser.sftpgroup /data/sftp/upload
```
>Важно: убедитесь, что владелец` /data/sftpuser` - `root`, это обязательно для изменения корневого каталога в **SFTP**.

Далее нужно настроить сервер так, чтобы когда пользователь, из группы **sftpgroup**, входил в систему, он попадал в **sftp** вместо обычной оболочки, в которую попадает через **ssh**. Для этого нужно добавьте фрагмент кода в файл `/etc/ssh/sshd_config`. 
```
$ vi /etc/ssh/sshd_config
```
Добавляем следующее:
```
Match Group sftpgroup
ChrootDirectory /data/%u
ForceCommand internal-sftp
```
**ChrootDirectory** позволяет создать необходимый каталог в качестве корневого узла (/ каталог) в дереве каталогов. Вошедший в систему пользователь не сможет увидеть ничего выше этого каталога и это не даст ему получить доступ к файлам других пользователей. `%u` - это код для заполнения текущим именем пользователя во время входа в систему.

Чтобы выполнить внесенные в `sshd_config` изменения, перезапустите службу:
```
$ sudo systemctl restart sshd
```
Доступ по **sftp** осуществляется аналогично с **ssh** →` sftp username@host` (чтобы узнать ip-адрес хоста выполните команду ip a) :
```
$ sftp sftpuser@192.168.183.128
```

После успешеного подключения:
- загрузка файлов с удаленного хоста: 
  `sftp> get FileName`
- По умолчанию команда get загружает удаленный файл и сохраняет файл с тем же именем в локальной файловой системе. Мы можем указать имя, с которым сохранится файл, добавив его в вышеуказанную команду: 
  `sftp> get FileName NewName`
- Команда `get` также имеет несколько флагов. Например, мы можем скопировать каталог и все его содержимое с помощью рекурсивной опции: 
  `sgtp> get -r DirectoryName`
- Передача файлов в удаленную систему осуществляется таким же удобным образом с помощью команды с именем «`put`»:
  `sftp> put FileName`
- Директории передаются аналогичным с получением образом:
  `sgtp> put -r DirectoryName`
- Команда `!` перемещает нас в локальную оболочку, где можно запустить любую команду в локальной системе. Выполнив её, мы можем проверить использование диска также с помощью `df -h`. Чтобы вернуться в сеанс **SFTP**, введите `exit` . 

### WinSCP

Для передачи файлов с клиента под управлением **Windows** существует **FTP**-клиент **WinSCP**. Это свободный графический клиент протоколов **SFTP** и **SCP**, предназначенный для **Windows**. Благодаря графическому интерфейсу воспользоваться им не составит труда даже начинающему пользователю. Первым делом нужно скачать установщик с официального сайта ([winscp.net](http://winscp.net/)) и, следуя его указаниям, выполнить установку программы. При открытии пользователя встречает окно подключения к серверу:![[Pasted image 20240716081618.png]]
Для подключения к нашем **sftp**-серверу введите **ip**-адрес в поле имя хоста, укажите порт **22** (если не меняли), имя пользователя и пароль.

При успешном подключении увидим следующую картину:![[Pasted image 20240716081733.png]]
Для получения файла с сервера нажмите на соответствующий пункт и укажите путь, куда вы хотите сохранить файл:
![[Pasted image 20240716081748.png]]
Для загрузки файла на сервер достаточно перетащить его из папки на клиенте в нужный каталог, открытый в WinSCP:![[Pasted image 20240716081807.png]]
![[Pasted image 20240716081825.png]]

---

### Samba

**Samba** – это программное обеспечение для реализации файлового сервера. Данный сервис дает возможность обращаться к сетевым дискам и принтерам по протоколу **SMB**/**CIFS**. Имеет клиентскую и серверную части. **Samba** – свободно распространяемое ПО. Начиная с версии 4 в **Samba** была реализована возможность выступать в роли контроллера домена и аналога сервиса **Active Directory**.

Устанавливая Samba и базовые сетевые службы (**DNS**, **NTP**, **Kerberos**) на один из **Linux**-дистрибутивов вы получаете следующую функциональность:

1. Контроллер домена **Active Directory**:
	- Служба Аутентификации на базе **Kerberos v5**
	- **LDAP**-совместимая служба каталогов c возможностью репликации по **DRS**
	- Сервер управления групповыми политиками
	- **DNS**-сервер на базе **BIND**
2. Файловый сервер
3. Сервер печати

_Прежде чем приступить к установке, убедитесь, что вы вошли в систему как пользователь с правами суперпользователя, а также обновите пакеты (apt update и apt upgrade)_.

Для установки выполните:
```
$ apt install samba 
```
Проверим корректность установки:
```
$ systemctl status smbd
```
Создадим директорию, в которую будем организовывать общий доступ, и в ней тестовый текстовый файл:
```
$ mkdir /Samba_Dir
$ touch /Samb_Dir/FileToShare
```
Установим полные права доступа всем пользователям на созданный только что каталог `Samba_Dir`:
```
$ chmod 777 /Samba_Dir
```
Откроем файл конфигурации **samba** `/etc/samba/smb.conf` и пропишем там следующие настройки:
![[Pasted image 20240716082210.png]]
В случае, если **samba**-сервер не работает, одной из причин может быть ошибка в конфигурационном файле. Чтобы не искать её вручную, была создана утилита **testparm**. После анализа заданного конфигурационного файла **testparm** выводит все значения файла `smb.conf`, включая значения по умолчанию. Это помогает убедиться, что используются ожидаемые значения параметров конфигурации. Стоит отметить, что значения по умолчанию меняются от версии к версии, так что необходимо использовать версию **Samba**, соответствующую версии **testparm**.

Использование:
```
$ testparm /etc/samba/smb.conf
```

Теперь перезапустим **samba** командой `systemctl restart smbd` и убедимся в том, что все работает, зайдя в нашу папку со сторонней **windows** машины. Для этого в проводнике вместо пути пропишите **ip**-адрес файлового сервера (узнать его можно с помощью команды ip a):![[Pasted image 20240716082454.png]]

### Filezilla

Протокол **FTP** в наши дни очень часто используется многими веб-мастерами и разработчиками для загрузки файлов на сервера, управления файлами сайтов и решения других подобных задач. Такой популярности этот протокол набрал потому, что он прост в использовании и не требует особых знаний устройства и команд операционных систем **Linux**.

Для демонстрации развернем на виртуальной машине **FTP**-сервер. Будем использовать **FTP**-сервер **VSFTPD** (**Very Secure FTP Daemon**), который обеспечивает самую надёжную защиту от уязвимостей.

**Установка vsftpd**:
`$ sudo apt install vsftpd`

Заранее создадим файл со списком пользователей `vsftpd`:
`$ sudo nano /etc/vsftpd.userlist`

И добавим пользователя `ftpu`:
`$ sudo useradd ftpu`
`$ sudo passwd ***`

Добавьте его имя в файл `**/etc/vsftpd.userlist`,** чтобы ****предоставить FTP-доступ пользователю:
`$ echo "ftpu" | sudo tee -a /etc/vsftpd.userlist`

Сами **настройки vsftpd** хранятся в конфигурационном файле **`/etc/vsftpd.conf`**
Прежде чем вносить в него изменения создадим резервную копию:
`$ sudo cp /etc/vsftpd.conf /etc/vsftpd.conf.orig`

Теперь откроем файл:
`$ sudo nano /etc/vsftpd.conf`

Добавьте такие настройки. Вам нужно будет найти и изменить значения указанных строк, или, если таковые отсутствуют, добавить новые.
```
listen=YES  #Указываем, что нужно ожидать входящих соединений
```
```
listen_ipv6=NO
```
```
connect_from_port_20=YES #Использовать порт 20 для передачи данных вместо случайного
```
```
anonymous_enable=NO #отключаем анонимный вход
```
```
local_enable=YES #Разрешаем использовать имена локальных пользователей для входа
```
```
write_enable=YES #Для авторизованных пользователей разрешаем команды, позволяющие изменять файловую систему
```

```
chroot_local_user=YES
allow_writeable_chroot=YES
#При входе пользователей на FTP-сервер, они могут работать
#только в корневом каталоге FTP.
#Если вы хотите, чтобы пользователи были ограничены только своей домашней папкой,
#то необходимо раскомментировать эти строчки:
```
```
secure_chroot_dir=/var/run/vsftpd/empty
```
```
pam_service_name=vsftpd #Использовать PAM-библиотеки
```
```
userlist_enable=YES #разрешим аутентификацию только пользователей, перечисленных в файле userlist:
```
```
userlist_file=/etc/vsftpd.userlist #Указываем файл с виртуальными пользователями
```
```
userlist_deny=NO #По умолчанию пользователям из userlist запрещён вход в систему, данная настройка делает наоборот
```
Затем необходимо **включить** сервис **vsftpd**, поскольку он не будет запущен по умолчанию, а также добавить службу в автозагрузку:
`$ sudo systemctl start vsftpd`
`$ sudo systemctl enable vsftpd`

Проверим статус сервиса:![[Pasted image 20240716083100.png]]

Один из самых популярных **FTP** клиентов, который используется множеством пользователей различных платформ, включая **Windows**, **MacOS** и даже **Linux**. Эта программа позволяет очень просто подключаться к удаленному серверу, выполнять там нужные действия, например, редактировать файлы, загружать их или скачивать, а также удобно просматривать файловую систему. В этой статье мы рассмотрим как пользоваться **FileZilla** для решения своих задач.

Для установки программы используйте такую команду:
`$ sudo apt install filezilla`

Откроем программу через графический интерфейс:
![[Pasted image 20240716083207.png]]
Для подключения к удаленному серверу введите **ip**-адрес сервера в поле **Host**, имя созданного пользователя в поле **Username** и пароль пользователя в поле **Password**. Нажмите **quickconnect**.

После подключения у Вас в одной части экрана будут видны локальные файлы, а в другой части будут файлы и директории на удаленном сервере. Вы можете _копировать_ их в любую сторону простым перетаскиванием из одной части рабочей области в другую, точно так же, как и в обычном проводнике **Windows**. Вы также можете _удалять_ файлы, _перемещать (переименовывать)_, _редактировать_ их и _изменять права доступа_ (chmod) к файлам и директориям на сервере.